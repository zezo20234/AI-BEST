<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Always-On Voice Flight Logger (Firebase)</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 30px; background: linear-gradient(135deg, #74ebd5, #ACB6E5); }
    input, button { padding: 10px; margin: 5px; font-size: 16px; border-radius: 5px; border: none; }
    button { cursor: pointer; transition: all 0.2s ease-in-out; background-color: #4CAF50; color: white; }
    button:hover { background-color: #45a049; transform: scale(1.05); }
    #flightBox { background: #fff; border-radius: 15px; padding: 20px; display: inline-block; margin-top: 20px; box-shadow: 0px 8px 20px rgba(0,0,0,0.3); min-width: 320px; transition: all 0.3s ease-in-out; transform: scale(0); opacity: 0; }
    #flightBox.show { transform: scale(1); opacity: 1; }
    #status { font-weight: bold; margin-top: 15px; color: #fff; text-shadow: 1px 1px 2px #000; }
    #logList { margin-top: 20px; text-align: left; display: none; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; }
</style>
</head>
<body>

<h1 style="color:#fff; text-shadow:2px 2px 4px #000;">Interactive Flight Logger</h1>

<div id="setup">
    <input type="text" id="callsign" placeholder="Flight Callsign"><br>
    <input type="text" id="depAirport" placeholder="Departure Airport"><br>
    <input type="text" id="arrAirport" placeholder="Arrival Airport"><br>
    <input type="number" id="cruiseAlt" placeholder="Cruise Altitude (ft)"><br>
    <button onclick="startFlight()">Start Flight</button>
</div>

<div id="flightControls" style="display:none;">
    <button onclick="logPhase('Takeoff')">Takeoff</button>
    <button onclick="logPhase('Cruise')">Cruise</button>
    <button onclick="logPhase('Descent')">Descent</button>
    <button onclick="logPhase('Landing')">Landing</button>
    <button onclick="logPhase('Crash')">Crash</button>
    <button onclick="saveFlight()">Save Flight</button>
</div>

<div id="flightBox">
    <h2>Flight Info</h2>
    <p id="infoCallsign"></p>
    <p id="infoDep"></p>
    <p id="infoArr"></p>
    <p id="infoPhase"></p>
    <p id="infoCruiseAlt"></p>
</div>

<p id="status">Voice command listening: OFF</p>
<button id="startVoiceBtn" onclick="initVoice()">ðŸŽ¤ Enable Voice Control</button>
<button onclick="toggleSavedFlights()">ðŸ“œ Show Saved Flights</button>

<div id="logList"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
let flightData = {};
let flightLog = [];

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
  authDomain: "sharplabubu.firebaseapp.com",
  databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
  projectId: "sharplabubu",
  storageBucket: "sharplabubu.firebasestorage.app",
  messagingSenderId: "596148393481",
  appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
  measurementId: "G-4M25R3BF08"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Save to Firebase
function saveFlight() {
    const timestamp = new Date().toISOString();
    db.ref('flights/' + timestamp).set(flightData)
    .then(() => {
        console.log("Flight saved to Firebase");
        loadSavedFlights();
    })
    .catch(err => console.error("Error saving to Firebase:", err));
}

// Load from Firebase
function loadSavedFlights() {
    db.ref('flights').once('value', snapshot => {
        const data = snapshot.val();
        const logList = document.getElementById("logList");
        if (!data) {
            logList.innerHTML = "<em>No saved flights yet</em>";
            return;
        }
        let html = "";
        Object.keys(data).forEach(key => {
            const f = data[key];
            html += `<div><strong>${f.callsign}</strong> - ${f.depAirport} â†’ ${f.arrAirport} (${f.phase})</div>`;
        });
        logList.innerHTML = html;
    });
}

function toggleSavedFlights() {
    const logList = document.getElementById("logList");
    logList.style.display = logList.style.display === "none" ? "block" : "none";
    if (logList.style.display === "block") {
        loadSavedFlights();
    }
}

function startFlight() {
    const callsign = document.getElementById("callsign").value.trim();
    const depAirport = document.getElementById("depAirport").value.trim();
    const arrAirport = document.getElementById("arrAirport").value.trim();
    const cruiseAlt = document.getElementById("cruiseAlt").value.trim();

    if(!callsign || !depAirport || !arrAirport || !cruiseAlt){
        alert("Please fill in all fields!");
        return;
    }

    flightData = { callsign, depAirport, arrAirport, cruiseAlt, phase: "Not started" };
    flightLog = [];

    document.getElementById("setup").style.display = "none";
    document.getElementById("flightControls").style.display = "block";
    document.getElementById("flightBox").classList.add("show");
    updateFlightBox();
}

function updateFlightBox() {
    document.getElementById("infoCallsign").innerText = `Callsign: ${flightData.callsign}`;
    document.getElementById("infoDep").innerText = `Departure: ${flightData.depAirport}`;
    document.getElementById("infoArr").innerText = `Arrival: ${flightData.arrAirport}`;
    document.getElementById("infoPhase").innerText = `Current Phase: ${flightData.phase}`;
    document.getElementById("infoCruiseAlt").innerText = `Cruise Altitude: ${flightData.cruiseAlt} ft`;
}

function logPhase(phase) {
    flightData.phase = phase;
    flightLog.push({ time: new Date().toLocaleTimeString(), phase });
    updateFlightBox();
    if(phase.toLowerCase() === "landing") {
        speak("You have landed");
        saveFlight(); // auto-save after landing
    }
}

function speak(text) {
    const utter = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(utter);
}

// Voice recognition
let recognition;
function initVoice() {
    document.getElementById("startVoiceBtn").style.display = "none";
    startVoiceRecognition();
}

function startVoiceRecognition() {
    const status = document.getElementById("status");
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        status.innerText = "Voice recognition not supported";
        return;
    }
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => { status.innerText = "Voice command listening: ON"; };

    recognition.onerror = (e) => {
        console.error("Speech error", e);
        setTimeout(() => recognition.start(), 500);
    };

    recognition.onresult = (event) => {
        for(let i = event.resultIndex; i < event.results.length; i++){
            const transcript = event.results[i][0].transcript.toLowerCase().trim();
            console.log("Detected:", transcript);
            if(transcript.includes("take off") || transcript.includes("takeoff")) logPhase("Takeoff");
            else if(transcript.includes("cruise")) logPhase("Cruise");
            else if(transcript.includes("descent") || transcript.includes("descend")) logPhase("Descent");
            else if(transcript.includes("land") || transcript.includes("i landed")) logPhase("Landing");
            else if(transcript.includes("crash")) logPhase("Crash");
        }
    };

    recognition.onend = () => {
        recognition.start(); // keep always on
    };
    recognition.start();
}

// Auto-start if mic permission already granted
if (navigator.permissions) {
    navigator.permissions.query({name: 'microphone'}).then(result => {
        if (result.state === 'granted') {
            initVoice();
        }
    });
}
</script>

</body>
</html>
