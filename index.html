<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Flight Logger</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        text-align: center; 
        margin: 30px; 
        background: linear-gradient(135deg, #74ebd5, #ACB6E5); 
    }
    input, button { 
        padding: 10px; margin: 5px; font-size: 16px; border-radius: 5px; border: none; 
    }
    button { 
        width: 180px; cursor: pointer; transition: all 0.2s ease-in-out; 
        background-color: #4CAF50; color: white; 
    }
    button:hover { 
        background-color: #45a049; transform: scale(1.05); 
    }
    #flightBox {
        background: #ffffff;
        border-radius: 15px;
        padding: 20px;
        display: inline-block;
        margin-top: 20px;
        box-shadow: 0px 8px 20px rgba(0,0,0,0.3);
        min-width: 320px;
        transition: all 0.3s ease-in-out;
        transform: scale(0);
        opacity: 0;
    }
    #flightBox.show {
        transform: scale(1);
        opacity: 1;
    }
    #flightBox h2 { margin-bottom: 10px; color: #333; }
    #status { font-weight: bold; margin-top: 15px; color: #fff; text-shadow: 1px 1px 2px #000; }
</style>
</head>
<body>

<h1 style="color:#fff; text-shadow:2px 2px 4px #000;">Interactive Flight Logger</h1>

<div id="setup">
    <input type="text" id="callsign" placeholder="Flight Callsign"><br>
    <input type="text" id="depAirport" placeholder="Departure Airport"><br>
    <input type="text" id="arrAirport" placeholder="Arrival Airport"><br>
    <input type="number" id="cruiseAlt" placeholder="Cruise Altitude (ft)"><br>
    <button onclick="startFlight()">Start Flight</button>
</div>

<div id="flightControls" style="display:none;">
    <button onclick="logPhase('Takeoff')">Takeoff</button>
    <button onclick="logPhase('Cruise')">Cruise</button>
    <button onclick="logPhase('Descent')">Descent</button>
    <button onclick="logPhase('Landing')">Landing</button>
    <button onclick="logPhase('Crash')">Crash</button>
</div>

<div id="flightBox">
    <h2>Flight Info</h2>
    <p id="infoCallsign"></p>
    <p id="infoDep"></p>
    <p id="infoArr"></p>
    <p id="infoPhase"></p>
    <p id="infoCruiseAlt"></p>
</div>

<p id="status">Voice command listening: OFF</p>

<script>
const webhookUrl = "https://discordapp.com/api/webhooks/1405176152498245714/Z-mEXlgv2IGlnT44K49BluIkehIqyMa1W8ILARmdmVp7QUMGRli-VjDjswn5OwQGZdLi";

let flightData = {};

/**
 * Sends a formatted message to the Discord webhook.
 * @param {string} phase The current phase of the flight.
 * @param {number} repeat The number of times to send the message.
 */
function sendDiscordMessageBox(phase, repeat = 1) {
    const message = 
`@everyone
\`\`\`
Callsign: ${flightData.callsign}
Phase: ${phase}
Departure: ${flightData.depAirport}
Arrival: ${flightData.arrAirport}
Cruise Altitude: ${flightData.cruiseAlt} ft
\`\`\``;

    const body = JSON.stringify({ content: message });
    const headers = { "Content-Type": "application/json" };

    // Use a loop to send the message multiple times if specified
    for(let i = 0; i < repeat; i++) {
        fetch(webhookUrl, {
            method: "POST",
            headers: headers,
            body: body
        })
        .then(response => {
            if (response.ok) {
                console.log(`Successfully sent Discord message for phase: ${phase}`);
            } else {
                console.error(`Failed to send Discord message. Status: ${response.status}`);
            }
        })
        .catch(error => {
            console.error("Network or fetch error:", error);
        });
    }
}

// Start flight after entering info
function startFlight() {
    const callsign = document.getElementById("callsign").value.trim();
    const depAirport = document.getElementById("depAirport").value.trim();
    const arrAirport = document.getElementById("arrAirport").value.trim();
    const cruiseAlt = document.getElementById("cruiseAlt").value.trim();

    if(!callsign || !depAirport || !arrAirport || !cruiseAlt){
        alert("Please fill in all fields!");
        return;
    }

    flightData = { callsign, depAirport, arrAirport, cruiseAlt, phase: "Not started" };

    document.getElementById("setup").style.display = "none";
    document.getElementById("flightControls").style.display = "block";

    const flightBox = document.getElementById("flightBox");
    flightBox.classList.add("show");

    updateFlightBox();
    sendDiscordMessageBox("Preparing for departure");
}

// Update flight info box
function updateFlightBox() {
    document.getElementById("infoCallsign").innerText = `Callsign: ${flightData.callsign}`;
    document.getElementById("infoDep").innerText = `Departure: ${flightData.depAirport}`;
    document.getElementById("infoArr").innerText = `Arrival: ${flightData.arrAirport}`;
    document.getElementById("infoPhase").innerText = `Current Phase: ${flightData.phase}`;
    document.getElementById("infoCruiseAlt").innerText = `Cruise Altitude: ${flightData.cruiseAlt} ft`;
}

/**
 * Logs the flight phase and provides voice feedback for specific events.
 * @param {string} phase The new phase of the flight.
 */
function logPhase(phase) {
    flightData.phase = phase;
    updateFlightBox();

    switch(phase) {
        case 'Takeoff':
            speak("Taking off now.");
            sendDiscordMessageBox(phase);
            break;
        case 'Cruise':
            speak(`Climbing to ${flightData.cruiseAlt} feet.`);
            sendDiscordMessageBox(phase);
            break;
        case 'Descent':
            speak("Beginning descent.");
            sendDiscordMessageBox(phase);
            break;
        case 'Landing':
            speak("You have landed.");
            sendDiscordMessageBox(phase);
            break;
        case 'Crash':
            speak("Warning. The flight has crashed.");
            sendDiscordMessageBox(phase, 3);
            break;
        default:
            sendDiscordMessageBox(phase);
            break;
    }
}

// Speak text using the Web Speech API
function speak(text) {
    const utter = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(utter);
}

// Voice recognition
let recognition;
let isListening = false;
let autoRestartTimeout;

function startVoiceRecognition() {
    const status = document.getElementById("status");
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        status.innerText = "Voice recognition not supported";
        return;
    }

    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        status.innerText = "Voice command listening: ON";
        isListening = true;
        clearTimeout(autoRestartTimeout);
    };

    recognition.onerror = (e) => {
        console.error("Speech recognition error:", e);
        status.innerText = "Voice recognition error, retrying...";
        isListening = false;
        autoRestartTimeout = setTimeout(() => {
            if (!isListening) recognition.start();
        }, 1000);
    };

    recognition.onresult = (event) => {
        for(let i = event.resultIndex; i < event.results.length; i++){
            const transcript = event.results[i][0].transcript.toLowerCase().trim();
            console.log("Detected:", transcript);
            if(transcript.includes("take off") || transcript.includes("takeoff")) logPhase("Takeoff");
            else if(transcript.includes("cruise")) logPhase("Cruise");
            else if(transcript.includes("descent") || transcript.includes("descend")) logPhase("Descent");
            else if(transcript.includes("land") || transcript.includes("i landed")) logPhase("Landing");
            else if(transcript.includes("crash")) logPhase("Crash");
        }
    };

    recognition.onend = () => { 
        isListening = false;
        autoRestartTimeout = setTimeout(() => {
            if (!isListening) recognition.start();
        }, 500); 
    };

    recognition.start();
}

window.onload = startVoiceRecognition;
</script>

</body>
</html>
