<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LAZUZU Support</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; }
    #aiAssistantBtn { position: fixed; bottom: 20px; right: 20px; background:#4CAF50; color:white; border:none; padding:12px 16px; border-radius:50%; font-size:18px; cursor:pointer; z-index:1000; }
    #aiAssistantBox { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:flex; flex-direction:column; }
    #aiAssistantBox header { background:#4CAF50; color:white; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    #aiMessages { flex:1; overflow:auto; padding:12px; font-size:14px; }
    #aiInputRow { display:flex; border-top:1px solid #ddd; }
    #aiInput { flex:1; padding:12px; border:none; outline:none; font-size:16px; }
    #aiSendBtn { padding:12px 16px; background:#4CAF50; color:white; border:none; cursor:pointer; }
    .msg-you { margin-bottom:8px; }
    .msg-ai { margin-bottom:8px; color:#222; }
    .muted { color:#666; font-size:0.95em; }
    </style>
</head>
<body>

<!-- AI Button -->
<button id="aiAssistantBtn">ðŸ’¬</button>

<!-- Fullscreen AI Chat -->
<div id="aiAssistantBox" role="dialog" aria-hidden="true">
  <header>
    <div>LAZUZU Support Bot</div>
    <div>
      <button id="aiCloseBtn" aria-label="Close" style="background:transparent;border:none;color:white;font-size:20px;cursor:pointer;">âœ–</button>
    </div>
  </header>
  <div id="aiMessages" aria-live="polite"></div>
  <div id="aiInputRow">
    <input id="aiInput" type="text" placeholder="Type your message..." />
    <button id="aiSendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// TODO: Replace with your Firebase project config
const firebaseConfig = {
  apiKey: "REPLACE_ME_API_KEY",
  authDomain: "REPLACE_ME.firebaseapp.com",
  databaseURL: "https://REPLACE_ME.firebaseio.com",
  projectId: "REPLACE_ME",
  storageBucket: "REPLACE_ME.appspot.com",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const aiBtn = document.getElementById('aiAssistantBtn');
const aiBox = document.getElementById('aiAssistantBox');
const aiCloseBtn = document.getElementById('aiCloseBtn');
const aiMessages = document.getElementById('aiMessages');
const aiInput = document.getElementById('aiInput');
const aiSendBtn = document.getElementById('aiSendBtn');

let step = 0;
let requestData = {};

// Replace with your auth username if available; for demo we use "guest"
let currentUser = window.currentUser || "guest";

function appendAI(text, muted=false) {
  const d = document.createElement('div');
  d.className = 'msg-ai';
  d.innerHTML = '<strong>AI:</strong> ' + text + (muted ? ' <span class="muted">(please wait)</span>' : '');
  aiMessages.appendChild(d);
  aiMessages.scrollTop = aiMessages.scrollHeight;
}
function appendYou(text) {
  const d = document.createElement('div');
  d.className = 'msg-you';
  d.innerHTML = '<strong>You:</strong> ' + text;
  aiMessages.appendChild(d);
  aiMessages.scrollTop = aiMessages.scrollHeight;
}

aiBtn.addEventListener('click', () => {
  aiBox.style.display = 'flex';
  aiBox.setAttribute('aria-hidden','false');
  aiMessages.innerHTML = '';
  appendAI('Hello! I'm LAZUZU Support. Ask me about the site, or say "remove days" / "add credits" to open a request.');
});
aiCloseBtn.addEventListener('click', () => {
  aiBox.style.display = 'none';
  aiBox.setAttribute('aria-hidden','true');
});
aiSendBtn.addEventListener('click', sendMessage);
aiInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

async function sendMessage() {
  const raw = aiInput.value.trim();
  if (!raw) return;
  appendYou(raw);
  aiInput.value = '';

  // Permission flow detection
  const low = raw.toLowerCase();
  if (step === 0 && (low.includes('remove days') || low.includes('add credits') || low.includes('remove day') || low.includes('add credit'))) {
    requestData.type = low.includes('day') ? 'remove_days' : 'add_credits';
    appendAI('How many?', true);
    step = 1;
    return;
  }
  if (step === 1) {
    const n = parseInt(raw);
    if (isNaN(n) || n <= 0) {
      appendAI('Please provide a valid positive number.');
      return;
    }
    requestData.amount = n;
    appendAI('Please explain why this change is needed.', true);
    step = 2;
    return;
  }
  if (step === 2) {
    requestData.reason = raw;
    requestData.user = currentUser;
    requestData.timestamp = Date.now();
    requestData.status = 'pending';

    // write to Firebase
    try {
      await set(push(ref(db, 'permissions')), requestData);
      appendAI('Request sent â€” please wait for admin approval. Thank you!');
    } catch (err) {
      appendAI('Failed to send request: ' + err.message);
    }
    step = 0;
    requestData = {};
    return;
  }

  // Regular AI conversation: call backend function /api/ai
  try {
    const r = await fetch('/api/ai', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: raw })
    });
    const j = await r.json();
    if (j?.reply) appendAI(j.reply);
    else appendAI('No reply (unexpected).');
  } catch (err) {
    appendAI('AI backend error: ' + err.message);
  }
}
</script>
</body>
</html>
